# è½¦é¡¶å…‰ä¼å‘ç”µé‡è®¡ç®—å·¥å…·é›†

åŸºäºGPSè½¨è¿¹å’Œ3Då»ºç­‘æ¨¡å‹çš„è½¦è¾†å…‰ä¼å‘ç”µé‡è®¡ç®—ç³»ç»Ÿï¼Œæ”¯æŒå‡ºç§Ÿè½¦å’Œå…¬äº¤è½¦ä¸¤ç§è½¦è¾†ç±»å‹çš„æ‰¹é‡å¤„ç†ã€‚

**[English](README_EN.md)** | ä¸­æ–‡

---

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
  - [å‡ºç§Ÿè½¦å¤„ç†æµç¨‹](#å‡ºç§Ÿè½¦å¤„ç†æµç¨‹)
  - [å…¬äº¤è½¦å¤„ç†æµç¨‹](#å…¬äº¤è½¦å¤„ç†æµç¨‹)
- [è„šæœ¬è¯¦ç»†è¯´æ˜](#è„šæœ¬è¯¦ç»†è¯´æ˜)
- [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
- [è¾“å‡ºæ ¼å¼](#è¾“å‡ºæ ¼å¼)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä¸»è¦åŠŸèƒ½

- âœ… **åŒè½¦å‹æ”¯æŒ**: å‡ºç§Ÿè½¦å’Œå…¬äº¤è½¦ç‹¬ç«‹å¤„ç†æµç¨‹
- âœ… **GPUåŠ é€Ÿ**: ä½¿ç”¨PyTorch + triro/OptiXå®ç°8-10å€æ€§èƒ½æå‡
- âœ… **é«˜ç²¾åº¦é˜´å½±**: GPUå…‰çº¿è¿½è¸ªçš„å»ºç­‘é˜´å½±åˆ†æ
- âœ… **æ™ºèƒ½æ•°æ®å¤„ç†**: è‡ªåŠ¨è·å–æ°”è±¡æ•°æ®ã€åæ ‡è½¬æ¢ã€åœè½¦æ’å€¼
- âœ… **æ‰¹é‡å¹¶è¡Œ**: å¤šè¿›ç¨‹é¢„å¤„ç† + GPUæ‰¹é‡è®¡ç®—
- âœ… **å…¬äº¤çº¿è·¯åˆ†æ**: è‡ªåŠ¨ç»Ÿè®¡çº¿è·¯ã€ç­›é€‰ä»£è¡¨æ€§è½¨è¿¹

### ç³»ç»Ÿè¦æ±‚

**å¿…éœ€ä¾èµ–:**
```bash
# Python 3.8+
pip install pandas numpy geopandas shapely
pip install pyvista trimesh pvlib-python pyproj pyyaml tqdm
```

**GPUåŠ é€Ÿ (å¼ºçƒˆæ¨è):**
```bash
# PyTorch with CUDA
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

è¯¦ç»†GPUç¯å¢ƒé…ç½®è¯·å‚è€ƒ: [GPUç¯å¢ƒé…ç½®æŒ‡å—.md](GPUç¯å¢ƒé…ç½®æŒ‡å—.md)

---

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡æ•°æ®

```bash
# ç›®å½•ç»“æ„
data/
â”œâ”€â”€ shenzhen_building.geojson      # å»ºç­‘footprintæ•°æ®
â”œâ”€â”€ taxi/
â”‚   â””â”€â”€ raw/                        # åŸå§‹å‡ºç§Ÿè½¦GPSæ•°æ®
â””â”€â”€ bus/
    â””â”€â”€ raw/                        # åŸå§‹å…¬äº¤è½¦GPSæ•°æ®
```

### 2. é¢„å¤„ç†è½¨è¿¹

**å‡ºç§Ÿè½¦:**
```bash
python preprocess_taxi_trajectories.py
```

**å…¬äº¤è½¦:**
```bash
python preprocess_bus_trajectories.py
```

### 3. æ‰¹é‡è®¡ç®—å‘ç”µé‡

**å‡ºç§Ÿè½¦:**
```bash
python batch_process_trajectories_taxi.py
```

**å…¬äº¤è½¦:**
```bash
python batch_process_trajectories_bus.py
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### å‡ºç§Ÿè½¦å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®é¢„å¤„ç† (preprocess_taxi_trajectories.py)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥: raw/*.csv (åŸå§‹GPSæ•°æ®, æ— è¡¨å¤´)                            â”‚
â”‚ è¾“å‡º: processed/*_processed.csv                                 â”‚
â”‚                                                                  â”‚
â”‚ åŠŸèƒ½:                                                            â”‚
â”‚ - æ·»åŠ æ ‡å‡†åˆ—å (datetime, vehicle_id, lng, lat, ...)            â”‚
â”‚ - Datetimeè§£æ + æ—¶åŒºè½¬æ¢ (Asia/Shanghai)                       â”‚
â”‚ - æ•°æ®æ¸…æ´—: å»é‡ã€åæ ‡éªŒè¯ã€è§’åº¦æ¸…ç†                             â”‚
â”‚ - è½¦è¾†IDæå– (ç²¤B7J7Z8 â†’ Z8)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å»ºç­‘Meshå‡†å¤‡ (prepare_building_mesh_from_footprint.py)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥: shenzhen_building.geojson                                 â”‚
â”‚ è¾“å‡º: building_mesh.ply                                         â”‚
â”‚                                                                  â”‚
â”‚ åŠŸèƒ½:                                                            â”‚
â”‚ - å»ºç­‘footprint â†’ 3D meshè½¬æ¢                                   â”‚
â”‚ - å¯é€‰ç½‘æ ¼ç»†åˆ† (æé«˜é˜´å½±ç²¾åº¦)                                    â”‚
â”‚ - å¹¶è¡Œå¤„ç† (å¤šæ ¸CPUåŠ é€Ÿ)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰¹é‡å‘ç”µé‡è®¡ç®— (batch_process_trajectories_taxi.py)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥: processed/*_processed.csv + building_mesh.ply             â”‚
â”‚ è¾“å‡º: output_taxi/*_pv_generation.csv                           â”‚
â”‚                                                                  â”‚
â”‚ å­æµç¨‹:                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ 3.1 æ•°æ®å‡†å¤‡é˜¶æ®µ (å¤šè¿›ç¨‹å¹¶è¡Œ)                          â”‚       â”‚
â”‚ â”‚   - è¯»å–è½¨è¿¹                                           â”‚       â”‚
â”‚ â”‚   - è‡ªåŠ¨è·å–æ°”è±¡æ•°æ® (æ™ºèƒ½ç¼“å­˜)                        â”‚       â”‚
â”‚ â”‚   - åœè½¦æ’å€¼ (åˆ†è¾¨ç‡: 1åˆ†é’Ÿ)                           â”‚       â”‚
â”‚ â”‚   - æœˆä»½å…‹éš† (æ‰©å±•åˆ°å…¨å¹´12ä¸ªæœˆ)                        â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                         â†“                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ 3.2 å‘ç”µé‡è®¡ç®—é˜¶æ®µ (GPUæ‰¹é‡è®¡ç®—)                       â”‚       â”‚
â”‚ â”‚   - GPUå…‰çº¿è¿½è¸ª (å»ºç­‘é˜´å½±æ£€æµ‹)                         â”‚       â”‚
â”‚ â”‚   - POAè¾ç…§åº¦è®¡ç®— (ç›´å°„+æ•£å°„+åå°„)                     â”‚       â”‚
â”‚ â”‚   - ç”µæ± æ¸©åº¦æ¨¡å‹                                       â”‚       â”‚
â”‚ â”‚   - DC/ACåŠŸç‡è®¡ç®—                                      â”‚       â”‚
â”‚ â”‚   - èƒ½é‡ç§¯åˆ†                                           â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â”‚ é…ç½®å‚æ•°:                                                        â”‚
â”‚ - panel_area: 2.2 mÂ² (å‡ºç§Ÿè½¦è½¦é¡¶é¢ç§¯)                           â”‚
â”‚ - vehicle_height: 1.5 m                                         â”‚
â”‚ - max_vehicles: 1050 (é™åˆ¶å¤„ç†æ•°é‡)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…¬äº¤è½¦å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®é¢„å¤„ç† (preprocess_bus_trajectories.py)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥: raw/*.csv (åŸå§‹GPSæ•°æ®, åŒ…å«busline_nameåˆ—)                â”‚
â”‚ è¾“å‡º:                                                            â”‚
â”‚   - processed/*_processed.csv (ä¿ç•™busline_name)                â”‚
â”‚   - busline_summary.csv (çº¿è·¯ç»Ÿè®¡æ±‡æ€»)                          â”‚
â”‚   - representative_trajectories/*.csv (æ¯çº¿è·¯ä»£è¡¨è½¨è¿¹)          â”‚
â”‚                                                                  â”‚
â”‚ åŠŸèƒ½:                                                            â”‚
â”‚ - æ ‡å‡†åŒ–æ ¼å¼ (8åˆ—, åŒ…å«busline_name)                            â”‚
â”‚ - Datetimeè§£æ + æ—¶åŒºè½¬æ¢                                       â”‚
â”‚ - æ•°æ®æ¸…æ´— + NaNè¿‡æ»¤                                            â”‚
â”‚ - å…¬äº¤çº¿è·¯ç»Ÿè®¡:                                                  â”‚
â”‚   * è¯†åˆ«æ‰€æœ‰uniqueçº¿è·¯ (ç¤ºä¾‹: 1549æ¡)                           â”‚
â”‚   * ç»Ÿè®¡æ¯æ¡çº¿è·¯è½¦è¾†æ•°ã€è®°å½•æ•°                                   â”‚
â”‚ - ä»£è¡¨æ€§è½¨è¿¹é€‰æ‹©:                                                â”‚
â”‚   * æ¯æ¡çº¿è·¯é€‰æ‹©GPSè®°å½•æ•°æœ€å¤šçš„è½¦è¾†                              â”‚
â”‚   * è¾“å‡ºåˆ°ç‹¬ç«‹æ–‡ä»¶å¤¹                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ‰¹é‡å‘ç”µé‡è®¡ç®— (batch_process_trajectories_bus.py)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥: representative_trajectories/*.csv                         â”‚
â”‚ è¾“å‡º: output_bus/*_pv_generation.csv                            â”‚
â”‚                                                                  â”‚
â”‚ é…ç½®å‚æ•° (ä¸å‡ºç§Ÿè½¦ä¸åŒ):                                         â”‚
â”‚ - panel_area: 25 mÂ² (å…¬äº¤è½¦è½¦é¡¶é¢ç§¯æ›´å¤§)                        â”‚
â”‚ - vehicle_height: 3.0 m (å…¬äº¤è½¦æ›´é«˜)                            â”‚
â”‚ - max_vehicles: None (å¤„ç†å…¨éƒ¨1549æ¡çº¿è·¯)                       â”‚
â”‚                                                                  â”‚
â”‚ å…¶ä»–æµç¨‹åŒå‡ºç§Ÿè½¦                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è„šæœ¬è¯¦ç»†è¯´æ˜

### æ•°æ®é¢„å¤„ç†è„šæœ¬

#### `preprocess_taxi_trajectories.py`

**ç”¨é€”**: å‡ºç§Ÿè½¦GPSæ•°æ®é¢„å¤„ç†

**åŠŸèƒ½**:
- æ·»åŠ æ ‡å‡†åˆ—å (datetime, vehicle_id, lng, lat, speed, angle, operation_status)
- Datetimeè§£æå¹¶è½¬æ¢ä¸ºæ—¶åŒºæ„ŸçŸ¥æ ¼å¼ (Asia/Shanghai)
- æ•°æ®æ¸…æ´—: å»é‡ã€åæ ‡éªŒè¯ã€è§’åº¦å¡«å……
- è½¦è¾†IDæå–å’Œæ ‡å‡†åŒ–

**è¾“å‡ºæ ¼å¼**:
```csv
datetime,vehicle_id,lng,lat,speed,angle,operation_status
2019-08-15 10:45:30+08:00,Z8,114.002296,22.537403,0.0,169.56,0
```

**é…ç½®**:
```python
CONFIG = {
    'input_dir': '<your_raw_data_path>',
    'output_dir': '<your_processed_data_path>',
    'processing': {
        'chunk_size': 1000,        # åˆ†å—è¯»å– (å¤§æ–‡ä»¶ä¼˜åŒ–)
        'n_jobs': 10,              # å¹¶è¡Œè¿›ç¨‹æ•°
    }
}
```

**è¿è¡Œ**:
```bash
python preprocess_taxi_trajectories.py
```

---

#### `preprocess_bus_trajectories.py`

**ç”¨é€”**: å…¬äº¤è½¦GPSæ•°æ®é¢„å¤„ç† + çº¿è·¯ç»Ÿè®¡ + ä»£è¡¨æ€§è½¨è¿¹é€‰æ‹©

**åŠŸèƒ½**:
- æ ‡å‡†åŒ–æ ¼å¼ (8åˆ—, åŒ…å«busline_name)
- Datetimeè§£æå¹¶è½¬æ¢ä¸ºæ—¶åŒºæ„ŸçŸ¥æ ¼å¼ (Asia/Shanghai)
- æ•°æ®æ¸…æ´— + NaNè¿‡æ»¤
- å…¬äº¤çº¿è·¯ç»Ÿè®¡å’Œä»£è¡¨æ€§è½¨è¿¹é€‰æ‹©

**è¾“å‡º**:

1. **é¢„å¤„ç†æ–‡ä»¶** (`processed/*_processed.csv`):
```csv
datetime,vehicle_id,lng,lat,speed,angle,operation_status,busline_name
2019-08-15 10:45:30+08:00,B12345,114.002296,22.537403,0.0,169.56,0,M123è·¯
```

2. **çº¿è·¯æ±‡æ€»** (`busline_summary.csv`):
```csv
busline_name,vehicle_count,total_records,avg_records_per_vehicle
M123è·¯,25,125000,5000
M456è·¯,18,90000,5000
...
```

3. **ä»£è¡¨æ€§è½¨è¿¹** (`representative_trajectories/M123è·¯_representative_processed.csv`):
- æ¯æ¡çº¿è·¯é€‰æ‹©GPSè®°å½•æ•°æœ€å¤šçš„è½¦è¾†

**é…ç½®**:
```python
CONFIG = {
    'input_dir': '<your_bus_raw_data_path>',
    'output_dir': '<your_bus_processed_data_path>',
    'processing': {
        'chunk_size': 100000,
        'n_jobs': 10,
    }
}
```

**è¿è¡Œ**:
```bash
python preprocess_bus_trajectories.py
```

---

### å»ºç­‘æ•°æ®å¤„ç†è„šæœ¬

#### `prepare_building_mesh_from_footprint.py`

**ç”¨é€”**: å°†å»ºç­‘footprintæ•°æ®è½¬æ¢ä¸º3D mesh

**è¾“å…¥è¦æ±‚**:
- æ ¼å¼: GeoJSON / Shapefile / GeoPackage
- å¿…éœ€å­—æ®µ:
  - `geometry`: Polygon (WGS84, EPSG:4326)
  - `height`: å»ºç­‘é«˜åº¦(ç±³)

**è¾“å‡º**: `.ply` æ ¼å¼çš„trimeshæ–‡ä»¶

**é…ç½®**:
```python
CONFIG = {
    'FOOTPRINT_PATH': '../data/shenzhen_building.geojson',
    'OUTPUT_MESH_PATH': '../data/shenzhen_building_mesh.ply',
    'GRID_SIZE': None,    # ç½‘æ ¼ç»†åˆ†ç²¾åº¦(ç±³), None=ä¸ç»†åˆ†
    'N_JOBS': 20,         # å¹¶è¡Œè¿›ç¨‹æ•°
    'BATCH_SIZE': None,   # è‡ªåŠ¨åˆ†é…
}
```

**è¿è¡Œ**:
```bash
python prepare_building_mesh_from_footprint.py
```

**æ€§èƒ½**:
- å•è¿›ç¨‹: ~å‡ åˆ†é’Ÿ (å–å†³äºå»ºç­‘æ•°é‡)

---

#### `fetch_irradiance_data.py`

**ç”¨é€”**: æ‰‹åŠ¨è·å–å¤ªé˜³è¾å°„æ•°æ® (é€šå¸¸ç”±æ‰¹å¤„ç†è„šæœ¬è‡ªåŠ¨è°ƒç”¨)

**æ•°æ®æº**: Open-Meteo API

**é…ç½®**:
```python
CONFIG = {
    'LAT': 22.543099,
    'LON': 114.057868,
    'START_DATE': '2019-01-01',
    'END_DATE': '2020-01-01',
    'GRANULARITY': '1min',        # '1min' æˆ– '1hour'
    'SAVE_CSV': True,
    'OUTPUT_DIR': 'irradiance_data',
}
```

**è¾“å‡º**:
- è‡ªåŠ¨ç¼“å­˜: `openmeteo_cache/*.parquet`
- å¯é€‰CSV: `irradiance_data/*.csv`

**è¿è¡Œ**:
```bash
python fetch_irradiance_data.py
```

---

### æ‰¹é‡è®¡ç®—è„šæœ¬

#### `batch_process_trajectories_taxi.py`

**ç”¨é€”**: å‡ºç§Ÿè½¦å‘ç”µé‡æ‰¹é‡è®¡ç®—

**è¾“å…¥**:
- è½¨è¿¹: `processed/*_processed.csv`
- å»ºç­‘: `building_mesh.ply`

**è¾“å‡º**:
- è¯¦ç»†ç»“æœ: `output_taxi/{vehicle_id}_pv_generation.csv`
- æ±‡æ€»æŠ¥å‘Š: `output_taxi/batch_summary.txt`

**é…ç½®**:
```python
CONFIG = {
    'location': {
        'name': 'æ·±åœ³å¸‚',
        'lat': 22.543099,
        'lon': 114.057868,
    },
    'data_sources': {
        'building_mesh_path': '<your_building_mesh_path>',
        'trajectory_dir': '<your_processed_trajectory_path>',
    },
    'pv_system': {
        'panel_area': 2.2,              # å‡ºç§Ÿè½¦è½¦é¡¶é¢ç§¯ (mÂ²)
        'panel_efficiency': 0.20,       # å…‰ä¼æ¿æ•ˆç‡
        'tilt': 0,                      # å€¾è§’ (åº¦)
        'vehicle_height': 1.5,          # è½¦é¡¶é«˜åº¦ (m)
    },
    'computation': {
        'clone_to_all_months': True,    # å…‹éš†åˆ°å…¨å¹´12ä¸ªæœˆ
        'max_vehicles': 1050,           # æœ€å¤§å¤„ç†è½¦è¾†æ•°
        'parking_threshold_minutes': 2, # åœè½¦é˜ˆå€¼
        'interpolation_resolution_minutes': 1,  # æ’å€¼åˆ†è¾¨ç‡
        'num_prepare_workers': 5,       # æ•°æ®å‡†å¤‡è¿›ç¨‹æ•°
        'gpu_batch_size': 100,          # GPUæ‰¹å¤„ç†å¤§å°
    },
    'output': {
        'output_dir': 'output_taxi',
    },
}
```

**è¿è¡Œ**:
```bash
python batch_process_trajectories_taxi.py
```

**å¤„ç†æµç¨‹**:
1. **å¹¶è¡Œæ•°æ®å‡†å¤‡** (5ä¸ªworkerè¿›ç¨‹):
   - è¯»å–è½¨è¿¹
   - è·å–æ°”è±¡æ•°æ®
   - åœè½¦æ’å€¼
   - æœˆä»½å…‹éš†
   - æ”¾å…¥é˜Ÿåˆ—

2. **GPUæ‰¹é‡è®¡ç®—** (ä¸»è¿›ç¨‹):
   - ä»é˜Ÿåˆ—å–æ•°æ®
   - GPUå…‰çº¿è¿½è¸ª
   - å‘ç”µé‡è®¡ç®—
   - ä¿å­˜ç»“æœ

**æ€§èƒ½** (NVIDIA RTX 3080):
- å•è½¦è¾†å…¨å¹´æ•°æ®: ~5ç§’
- 1050è¾†è½¦: ~1.5å°æ—¶ (è¿ç»­è¿è¡Œ)

---

#### `batch_process_trajectories_bus.py`

**ç”¨é€”**: å…¬äº¤è½¦å‘ç”µé‡æ‰¹é‡è®¡ç®—

**è¾“å…¥**:
- è½¨è¿¹: `representative_trajectories/*_representative_processed.csv`
- å»ºç­‘: `building_mesh.ply`

**è¾“å‡º**:
- è¯¦ç»†ç»“æœ: `output_bus/{busline}_pv_generation.csv`
- æ±‡æ€»æŠ¥å‘Š: `output_bus/batch_summary.txt`

**é…ç½®** (ä¸å‡ºç§Ÿè½¦çš„å·®å¼‚):
```python
CONFIG = {
    # ... (locationå’Œbuilding_mesh_pathç›¸åŒ)

    'data_sources': {
        'trajectory_dir': '<your_bus_representative_trajectory_path>',
    },
    'pv_system': {
        'panel_area': 25,               # âœ… å…¬äº¤è½¦è½¦é¡¶æ›´å¤§
        'panel_efficiency': 0.20,
        'tilt': 0,
        'vehicle_height': 3.0,          # âœ… å…¬äº¤è½¦æ›´é«˜
    },
    'computation': {
        'clone_to_all_months': True,
        'max_vehicles': None,           # âœ… ä¸é™åˆ¶ (å¤„ç†å…¨éƒ¨1549æ¡çº¿è·¯)
        # ... (å…¶ä»–å‚æ•°ç›¸åŒ)
    },
    'output': {
        'output_dir': 'output_bus',     # âœ… ç‹¬ç«‹è¾“å‡ºç›®å½•
    },
}
```

**è¿è¡Œ**:
```bash
python batch_process_trajectories_bus.py
```

**æ€§èƒ½** (NVIDIA RTX 3080):
- å•çº¿è·¯å…¨å¹´æ•°æ®: ~0.5ç§’
- 1549æ¡çº¿è·¯: ~10min (è¿ç»­è¿è¡Œ)

---

### æ ¸å¿ƒè®¡ç®—æ¨¡å—

#### `pv_generation_pvlib.py`

**ç”¨é€”**: å…‰ä¼å‘ç”µè®¡ç®—å™¨åŸºç±» (CPUç‰ˆæœ¬)

**åŠŸèƒ½**:
- å¤ªé˜³ä½ç½®è®¡ç®— (pvlib)
- GPSåæ ‡è½¬æ¢ (WGS84 â†’ å±€éƒ¨ç¬›å¡å°”)
- å…‰çº¿è¿½è¸ª (trimesh + triro/OptiX)
- POAè¾ç…§åº¦è®¡ç®—
- DC/ACåŠŸç‡è®¡ç®—

**ä¸»è¦ç±»**:
```python
class SolarPVCalculator:
    def __init__(self, lon_center, lat_center, building_mesh,
                 panel_area=2.0, panel_efficiency=0.22, ...):
        pass

    def calculate_generation(self, trajectory_df, irradiance_df):
        """è®¡ç®—å‘ç”µé‡"""
        pass
```

---

#### `pv_calculator_gpu.py`

**ç”¨é€”**: GPUåŠ é€Ÿç‰ˆå…‰ä¼è®¡ç®—å™¨

**ç»§æ‰¿è‡ª**: `SolarPVCalculator`

**GPUä¼˜åŒ–**:
- PyTorchæ‰¹é‡å…‰çº¿ç”Ÿæˆ
- GPUå¹¶è¡ŒåŠŸç‡è®¡ç®—
- é¢„æ„å»ºåæ ‡è½¬æ¢å™¨
- æ‰¹å¤„ç†ä¼˜åŒ–

**ä¸»è¦ç±»**:
```python
class GPUAcceleratedSolarPVCalculator(SolarPVCalculator):
    def __init__(self, *args, use_gpu=True, **kwargs):
        # è‡ªåŠ¨æ£€æµ‹CUDA
        self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
```

**æ€§èƒ½æå‡**: CPUæ¨¡å¼ â†’ GPUæ¨¡å¼ çº¦ **8-10å€**

---

## é…ç½®æŒ‡å—

### å‡ºç§Ÿè½¦ vs å…¬äº¤è½¦é…ç½®å¯¹æ¯”

| å‚æ•° | å‡ºç§Ÿè½¦ | å…¬äº¤è½¦ | è¯´æ˜ |
|-----|-------|--------|-----|
| `panel_area` | 2.2 mÂ² | 25 mÂ² | å…¬äº¤è½¦è½¦é¡¶é¢ç§¯æ›´å¤§ |
| `vehicle_height` | 1.5 m | 3.0 m | å…¬äº¤è½¦æ›´é«˜ |
| `max_vehicles` | 1050 | None | å…¬äº¤è½¦å¤„ç†å…¨éƒ¨çº¿è·¯ |
| `trajectory_dir` | `taxi/processed/` | `bus/representative_trajectories/` | ä¸åŒæ•°æ®æº |
| `output_dir` | `output_taxi/` | `output_bus/` | ç‹¬ç«‹è¾“å‡º |

### GPUæ˜¾å­˜ä¼˜åŒ–

| æ˜¾å­˜ | æ¨èbatch_size | è¯´æ˜ |
|-----|---------------|------|
| 4GB | 20-50 | å°æ‰¹é‡ |
| 6GB | 50-100 | ä¸­ç­‰æ‰¹é‡ |
| 8GB | 100-200 | å¤§æ‰¹é‡ |
| 12GB+ | 200-500 | è¶…å¤§æ‰¹é‡ |

**å¦‚æœé‡åˆ°CUDA out of memory**:
```python
CONFIG = {
    'computation': {
        'gpu_batch_size': 50,  # å‡å°æ‰¹å¤„ç†å¤§å°
    }
}
```

### åœè½¦æ’å€¼é…ç½®

```python
CONFIG = {
    'computation': {
        'parking_threshold_minutes': 2,          # åœè½¦é˜ˆå€¼
        'interpolation_resolution_minutes': 1,   # æ’å€¼åˆ†è¾¨ç‡
    }
}
```

**è¯´æ˜**:
- åœè½¦é˜ˆå€¼: è¿ç»­ä¸¤ç‚¹é—´éš”è¶…è¿‡æ­¤æ—¶é—´ä¸”ä½ç½®ä¸å˜ â†’ åˆ¤å®šä¸ºåœè½¦
- æ’å€¼åˆ†è¾¨ç‡: åœ¨åœè½¦æ—¶æ®µå†…æ’å€¼çš„æ—¶é—´é—´éš”
- åœè½¦æœŸé—´æŒç»­è®¡ç®—å‘ç”µé‡ (å¤ªé˜³ä½ç½®å˜åŒ–)

---

## è¾“å‡ºæ ¼å¼

### è¯¦ç»†ç»“æœCSV

**æ–‡ä»¶**: `output_taxi/{vehicle_id}_pv_generation.csv`

| åˆ—å | è¯´æ˜ | å•ä½ | ç¤ºä¾‹ |
|-----|------|------|------|
| `datetime` | æ—¶é—´æˆ³ | - | `2019-08-15 10:50:11+08:00` |
| `lng`, `lat` | GPSåæ ‡ | åº¦ | `114.0023`, `22.5374` |
| `speed` | é€Ÿåº¦ | km/h | `0.0` (åœè½¦) |
| `angle` | è½¦è¾†æœå‘ | åº¦ | `169.56` (å—åä¸œ) |
| `month` | æœˆä»½ | 1-12 | `8` |
| `is_shaded` | é˜´å½±çŠ¶æ€ | 0/1/2/3/4 | `0`=æ— é®æŒ¡, `1-4`=ä¸åŒé®æŒ¡ç¨‹åº¦ |
| `poa_global` | å¹³é¢æ€»è¾ç…§åº¦ | W/mÂ² | `590.83` |
| `poa_direct` | ç›´å°„è¾ç…§åº¦ | W/mÂ² | `364.55` |
| `poa_diffuse` | æ•£å°„è¾ç…§åº¦ | W/mÂ² | `243.77` |
| `poa_reflected` | åå°„è¾ç…§åº¦ | W/mÂ² | `234.02` |
| `cell_temp` | ç”µæ± æ¸©åº¦ | Â°C | `40.57` |
| `dc_power` | ç›´æµåŠŸç‡ | W | `236.87` |
| `ac_power` | äº¤æµåŠŸç‡ | W | `226.06` (è€ƒè™‘é€†å˜å™¨æ•ˆç‡) |
| `delta_t_seconds` | æ—¶é—´é—´éš” | ç§’ | `60.0` |
| `energy_kwh` | èƒ½é‡ | kWh | `0.00395` |

### æ‰¹å¤„ç†æ±‡æ€»

**æ–‡ä»¶**: `output_taxi/batch_summary.txt`

```
================================================================================
  æ‰¹é‡å¤„ç†æ±‡æ€»æŠ¥å‘Š
================================================================================

å¤„ç†å®Œæˆæ—¶é—´: 2025-01-15 10:30:45
æ€»è®¡ç®—æ—¶é—´: 2å¤© 15å°æ—¶ 30åˆ†é’Ÿ

--------------------------------------------------------------------------------
  æ€»ä½“ç»Ÿè®¡
--------------------------------------------------------------------------------
æˆåŠŸå¤„ç†è½¦è¾†æ•°: 1050
æ€»å‘ç”µé‡: 15,234.56 kWh
å¹³å‡æ¯è¾†è½¦: 14.51 kWh

--------------------------------------------------------------------------------
  è¯¦ç»†ç»Ÿè®¡ (æŒ‰è½¦è¾†)
--------------------------------------------------------------------------------
è½¦è¾†ID    è½¨è¿¹ç‚¹æ•°    æ€»å‘ç”µé‡(kWh)    å¹³å‡åŠŸç‡(W)    é˜´å½±ç‡(%)    è®¡ç®—æ—¶é—´
------------------------------------------------------------------------
Z8        71,300      18.45           245.2          35.2        8åˆ†15ç§’
0G        125,531     25.67           218.9          42.1        12åˆ†38ç§’
...
```

---

## æ€§èƒ½ä¼˜åŒ–

### å¤šè¿›ç¨‹å¹¶è¡Œä¼˜åŒ–

**æ•°æ®å‡†å¤‡é˜¶æ®µ** (CPUå¯†é›†):
```python
CONFIG = {
    'computation': {
        'num_prepare_workers': 5,  # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
    }
}
```

**å»ºè®®**:
- CPUæ ¸å¿ƒæ•° â‰¤ 8: ä½¿ç”¨ 3-5 ä¸ªworker
- CPUæ ¸å¿ƒæ•° > 8: ä½¿ç”¨ 5-10 ä¸ªworker

### GPUæ‰¹å¤„ç†ä¼˜åŒ–

**GPUè®¡ç®—é˜¶æ®µ**:
```python
CONFIG = {
    'computation': {
        'gpu_batch_size': 100,  # æ ¹æ®æ˜¾å­˜è°ƒæ•´
    }
}
```

**è°ƒä¼˜ç­–ç•¥**:
1. è¿è¡Œæ—¶ç›‘æ§GPUæ˜¾å­˜: `nvidia-smi -l 1`
2. å¦‚æœæ˜¾å­˜åˆ©ç”¨ç‡ < 80%: å¢å¤§batch_size
3. å¦‚æœé‡åˆ°OOM: å‡å°batch_size

### æ—¶é—´åˆ†è¾¨ç‡æƒè¡¡

```python
CONFIG = {
    'computation': {
        'interpolation_resolution_minutes': 1,  # 1/5/10åˆ†é’Ÿ
    }
}
```

| åˆ†è¾¨ç‡ | ç²¾åº¦ | è®¡ç®—é‡ | é€‚ç”¨åœºæ™¯ |
|-------|-----|--------|---------|
| 1åˆ†é’Ÿ | æœ€é«˜ | æœ€å¤§ | ç ”ç©¶çº§ç²¾åº¦ |
| 5åˆ†é’Ÿ | é«˜ | ä¸­ç­‰ | ä¸€èˆ¬åˆ†æ |
| 10åˆ†é’Ÿ | ä¸­ | è¾ƒå° | å¿«é€Ÿä¼°ç®— |

---

## ç›¸å…³æ–‡æ¡£

- [GPUç¯å¢ƒé…ç½®æŒ‡å—.md](GPUç¯å¢ƒé…ç½®æŒ‡å—.md) - GPUç¯å¢ƒè¯¦ç»†é…ç½®
- **pvlib-python**: https://pvlib-python.readthedocs.io/
- **Open-Meteo API**: https://open-meteo.com/
- **PyVista**: https://docs.pyvista.org/
- **trimesh**: https://trimsh.org/

---

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›ç ”ç©¶ä½¿ç”¨ã€‚

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚