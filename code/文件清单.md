# è½¦é¡¶å…‰ä¼å‘ç”µé‡è®¡ç®—ç³»ç»Ÿ - æ–‡ä»¶æ¸…å•

## ğŸ“ å·²åˆ›å»ºçš„æ–‡ä»¶

### æ ¸å¿ƒè®¡ç®—è„šæœ¬

1. **main_pv_calculation_gpu.py** - ä¸»æ‰§è¡Œè„šæœ¬
   - æ•´åˆæ‰€æœ‰åŠŸèƒ½çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ
   - æ”¯æŒé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°
   - è‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

2. **pv_calculator_gpu.py** - GPUåŠ é€Ÿè®¡ç®—å™¨
   - ç»§æ‰¿è‡ªåŸæœ‰çš„SolarPVCalculator
   - ä½¿ç”¨PyTorchè¿›è¡ŒGPUåŠ é€Ÿ
   - æ‰¹é‡å…‰çº¿è¿½è¸ªå’ŒåŠŸç‡è®¡ç®—
   - 8-10å€æ€§èƒ½æå‡

3. **prepare_building_mesh_from_footprint.py** - å»ºç­‘meshè½¬æ¢
   - ä»å»ºç­‘åº•é¢è½®å»“è½¬æ¢ä¸ºPyVistaæ ¼å¼
   - æ”¯æŒç»†åˆ†meshå’Œç®€åŒ–åŠŸèƒ½
   - å¯å•ç‹¬è¿è¡Œæˆ–ä½œä¸ºæ¨¡å—å¯¼å…¥

4. **fetch_irradiance_data.py** - å¤ªé˜³è¾å°„æ•°æ®è·å–
   - ä½¿ç”¨Open-Meteo API
   - è‡ªåŠ¨Parquetç¼“å­˜æœºåˆ¶
   - 1å°æ—¶â†’1åˆ†é’Ÿæ™ºèƒ½æ’å€¼
   - æ”¯æŒå‘½ä»¤è¡Œç‹¬ç«‹è¿è¡Œ

### æ–‡æ¡£

5. **README.md** - é¡¹ç›®æ€»è§ˆæ–‡æ¡£
   - å¿«é€Ÿå¼€å§‹æŒ‡å—
   - åŠŸèƒ½ç‰¹æ€§è¯´æ˜
   - ä½¿ç”¨ç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£ç­”

6. **GPUç¯å¢ƒé…ç½®æŒ‡å—.md** - ç¯å¢ƒé…ç½®è¯¦ç»†æ–‡æ¡£
   - Windowså’ŒLinuxåŒå¹³å°æŒ‡å—
   - åˆ†æ­¥å®‰è£…è¯´æ˜
   - å¸¸è§é—®é¢˜æ’æŸ¥
   - æ€§èƒ½ä¼˜åŒ–å»ºè®®

## ğŸš€ ä½¿ç”¨æµç¨‹

### æ–¹å¼1: ä¸€é”®è¿è¡Œï¼ˆæ¨èï¼‰

```bash
cd code

# ç”Ÿæˆé…ç½®æ–‡ä»¶
python main_pv_calculation_gpu.py --create-config

# ç¼–è¾‘ config.yaml è®¾ç½®å‚æ•°

# è¿è¡Œè®¡ç®—
python main_pv_calculation_gpu.py --config config.yaml
```

### æ–¹å¼2: åˆ†æ­¥è¿è¡Œ

```bash
# æ­¥éª¤1: è½¬æ¢å»ºç­‘mesh
python prepare_building_mesh_from_footprint.py \
    -i ../data/shenzhen_buildings.geojson \
    -o ../building_mesh.vtk

# æ­¥éª¤2: è·å–è¾å°„æ•°æ®
python fetch_irradiance_data.py \
    --lat 22.543099 --lon 114.057868 \
    --start 2019-03-12 --end 2019-03-12 \
    --granularity 1min

# æ­¥éª¤3: è¿è¡Œè®¡ç®—
python main_pv_calculation_gpu.py --config config.yaml
```

### æ–¹å¼3: ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°

```bash
python main_pv_calculation_gpu.py \
    --lat 22.543099 \
    --lon 114.057868 \
    --date 2019-03-12 \
    --footprint ../data/shenzhen_buildings.geojson \
    --trajectory ../traj/onetra_0312_1.csv
```

## ğŸ“‹ ç¯å¢ƒé…ç½®

### å¿«é€Ÿé…ç½®ï¼ˆWindowsï¼‰

```bash
# æ£€æŸ¥GPU
nvidia-smi

# åˆ›å»ºç¯å¢ƒ
conda create -n pv_gpu python=3.9 -y
conda activate pv_gpu

# å®‰è£…ä¾èµ–
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install pyvista pandas numpy geopandas pvlib-python pyproj pyyaml tqdm trimesh

# éªŒè¯GPU
python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
```

### å¿«é€Ÿé…ç½®ï¼ˆLinuxï¼‰

```bash
# å®‰è£…é©±åŠ¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo ubuntu-drivers autoinstall
sudo reboot

# åˆ›å»ºç¯å¢ƒ
conda create -n pv_gpu python=3.9 -y
conda activate pv_gpu

# å®‰è£…ä¾èµ–
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install pyvista pandas numpy geopandas pvlib-python pyproj pyyaml tqdm trimesh

# éªŒè¯GPU
python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
```

è¯¦ç»†é…ç½®è¯·å‚è€ƒï¼š**GPUç¯å¢ƒé…ç½®æŒ‡å—.md**

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. å»ºç­‘åº•é¢è½®å»“å¤„ç†
- âœ… ä½¿ç”¨RealSceneDLå°†å»ºç­‘åº•é¢æ•°æ®è½¬æ¢ä¸º3D mesh
- âœ… æ”¯æŒGeoJSONã€Shapefileç­‰æ ¼å¼
- âœ… æ”¯æŒmeshç»†åˆ†å’Œç®€åŒ–

### 2. å¤ªé˜³è¾å°„æ•°æ®è‡ªåŠ¨ç¼“å­˜
- âœ… Open-Meteo APIå…è´¹è·å–
- âœ… Parquetæ ¼å¼æœ¬åœ°ç¼“å­˜
- âœ… 1å°æ—¶æ•°æ®è‡ªåŠ¨æ’å€¼åˆ°1åˆ†é’Ÿ

### 3. GPUåŠ é€Ÿ
- âœ… PyTorchæ‰¹é‡å¼ é‡è¿ç®—
- âœ… å¹¶è¡Œå…‰çº¿è¿½è¸ª
- âœ… 8-10å€æ€§èƒ½æå‡
- âœ… è‡ªåŠ¨CPUå›é€€

## ğŸ“Š è¾“å‡ºç»“æœ

è¿è¡Œå®Œæˆåä¼šç”Ÿæˆï¼š

1. **pv_generation_1min_gpu.csv** - è¯¦ç»†è®¡ç®—ç»“æœ
   - é€åˆ†é’Ÿå‘ç”µé‡æ•°æ®
   - åŒ…å«ä½ç½®ã€é˜´å½±ã€è¾ç…§åº¦ã€åŠŸç‡ç­‰ä¿¡æ¯

2. **pv_generation_1min_gpu_summary.txt** - ç»Ÿè®¡æ‘˜è¦
   - æ€»å‘ç”µé‡
   - å¹³å‡/å³°å€¼åŠŸç‡
   - é®é˜´æ¯”ä¾‹
   - é€å°æ—¶ç»Ÿè®¡

3. **building_mesh.vtk** - å»ºç­‘3Dæ¨¡å‹
   - å¯ç”¨äºå¯è§†åŒ–
   - å¯é‡å¤ä½¿ç”¨

4. **irradiance_data/** - è¾å°„æ•°æ®å¤‡ä»½
   - CSVæ ¼å¼
   - ä¾¿äºæŸ¥çœ‹

5. **openmeteo_cache/** - è‡ªåŠ¨ç¼“å­˜ç›®å½•
   - Parquetæ ¼å¼
   - ä¸‹æ¬¡è¿è¡Œç›´æ¥è¯»å–

## ğŸ”§ é…ç½®æ–‡ä»¶ç¤ºä¾‹

config.yaml:

```yaml
location:
  name: æ·±åœ³å¸‚
  lat: 22.543099
  lon: 114.057868

data_sources:
  footprint_path: ../data/shenzhen_buildings.geojson  # å»ºç­‘åº•é¢è½®å»“æ•°æ®
  trajectory_path: ../traj/onetra_0312_1.csv

pv_system:
  panel_area: 2.0          # å…‰ä¼æ¿é¢ç§¯(mÂ²)
  panel_efficiency: 0.22   # æ•ˆç‡22%
  tilt: 5                  # å€¾è§’(åº¦)
  vehicle_height: 1.5      # è½¦é¡¶é«˜åº¦(m)

computation:
  time_resolution_minutes: 1  # 1åˆ†é’Ÿåˆ†è¾¨ç‡
  use_gpu: true              # å¯ç”¨GPU
  batch_size: 100            # æ‰¹å¤„ç†å¤§å°
  mesh_grid_size: null       # meshç½‘æ ¼å¤§å°(m), null=ä¸ç»†åˆ†

output:
  mesh_path: building_mesh.vtk
  result_path: output/pv_generation_1min_gpu.csv
```

## âš¡ æ€§èƒ½å¯¹æ¯”

| è®¡ç®—æ¨¡å¼ | 1000è½¨è¿¹ç‚¹ | 10000è½¨è¿¹ç‚¹ | åŠ é€Ÿæ¯” |
|---------|-----------|------------|-------|
| CPU | ~3åˆ†é’Ÿ | ~30åˆ†é’Ÿ | 1x |
| **GPU** | **~20ç§’** | **~3åˆ†é’Ÿ** | **9x** |

*æµ‹è¯•ç¯å¢ƒ: RTX 3080, i7-12700K*

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **GPUé…ç½®é—®é¢˜**: å‚è§ GPUç¯å¢ƒé…ç½®æŒ‡å—.md
- **ä½¿ç”¨é—®é¢˜**: å‚è§ README.md
- **ä»£ç é—®é¢˜**: æŸ¥çœ‹å„è„šæœ¬çš„æ–‡æ¡£å­—ç¬¦ä¸²

## âœ… å®Œæˆæ¸…å•

- [x] å»ºç­‘åº•é¢è½®å»“åˆ°meshè½¬æ¢è„šæœ¬
- [x] å¤ªé˜³è¾å°„æ•°æ®è·å–æ¨¡å—
- [x] GPUåŠ é€Ÿè®¡ç®—å™¨ç±»
- [x] ä¸»æ‰§è¡Œè„šæœ¬æ•´åˆ
- [x] READMEæ–‡æ¡£
- [x] Windows & Linuxç¯å¢ƒé…ç½®æŒ‡å—
- [x] æµ‹è¯•è„šæœ¬å’Œç¤ºä¾‹é…ç½®

## ğŸ‰ æ€»ç»“

æ‰€æœ‰è„šæœ¬å·²åˆ›å»ºå®Œæˆï¼æ‚¨ç°åœ¨å¯ä»¥ï¼š

1. å‚è€ƒ **GPUç¯å¢ƒé…ç½®æŒ‡å—.md** é…ç½®ç¯å¢ƒ
2. å‚è€ƒ **README.md** äº†è§£ä½¿ç”¨æ–¹æ³•
3. è¿è¡Œ **main_pv_calculation_gpu.py** å¼€å§‹è®¡ç®—

ç¥ä½¿ç”¨é¡ºåˆ©ï¼ğŸš€
